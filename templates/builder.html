{% extends 'base.html' %}

{% block content %}
<div class="form-container" id="input-section">
    <h2>Build & Analyze Your Resume</h2>
    <p class="subtitle">Follow the 4-step wizard to create a professional, ATS-optimized resume.</p>

    <!-- Progress Bar -->
    <div style="display: flex; justify-content: space-between; margin-bottom: 30px; position: relative;">
        <div style="position: absolute; top: 50%; left: 0; width: 100%; height: 2px; background: #e5e7eb; z-index: 0;"></div>
        <div class="step-indicator active" id="ind-1" style="width: 30px; height: 30px; background: #4f46e5; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 1; font-weight: bold;">1</div>
        <div class="step-indicator" id="ind-2" style="width: 30px; height: 30px; background: #e5e7eb; color: #666; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 1; font-weight: bold;">2</div>
        <div class="step-indicator" id="ind-3" style="width: 30px; height: 30px; background: #e5e7eb; color: #666; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 1; font-weight: bold;">3</div>
        <div class="step-indicator" id="ind-4" style="width: 30px; height: 30px; background: #e5e7eb; color: #666; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 1; font-weight: bold;">4</div>
    </div>
    
    <form method="POST" action="{{ url_for('builder') }}" id="resumeForm" enctype="multipart/form-data">
        
        <!-- Step 1: Contact & Target -->
        <div class="form-step" id="step-1">
            <h3>Step 1: Contact & Target</h3>
            <div class="form-group">
                <label for="name">Legal Name</label>
                <input type="text" id="name" name="name" placeholder="John Doe" required>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input type="tel" id="phone" name="phone" placeholder="+233 XX XXX XXXX" required>
                </div>
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email" placeholder="john@example.com" required>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label for="country">Country</label>
                    <input type="text" id="country" name="country" placeholder="Ghana" required>
                </div>
                <div class="form-group">
                    <label for="photo">Passport Photo (Optional)</label>
                    <input type="file" id="photo" name="photo" accept="image/*" style="padding-top: 10px;">
                </div>
            </div>

            <div class="form-group">
                <label for="job_type">Job Industry</label>
                <select id="job_type" name="job_type" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                    <option value="">Select Industry...</option>
                    <option value="Banking & Finance">Banking & Finance</option>
                    <option value="Software & IT">Software & IT</option>
                    <option value="Healthcare">Healthcare</option>
                    <option value="Education">Education</option>
                    <option value="Construction">Construction</option>
                    <option value="Retail">Retail</option>
                    <option value="Manufacturing">Manufacturing</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label for="job_level">Job Level</label>
                    <select id="job_level" name="job_level" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="">Select Level...</option>
                        <option value="Student">Student / Intern</option>
                        <option value="Junior">Junior (0-3 years)</option>
                        <option value="Mid">Mid-Level (3-7 years)</option>
                        <option value="Senior">Senior (7+ years)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="years_experience">Years of Experience</label>
                    <input type="number" id="years_experience" name="years_experience" placeholder="e.g. 5" min="0" step="0.5" required>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label for="location_target">Job Location Target</label>
                    <select id="location_target" name="location_target" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="Ghana">Ghana</option>
                        <option value="International">International</option>
                        <option value="Remote">Remote</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="functional_focus">Functional Focus</label>
                    <input type="text" id="functional_focus" name="functional_focus" placeholder="e.g. Operations, Sales, Development" required>
                </div>
            </div>

            <div class="form-group">
                <label for="role">Position Aspiring For</label>
                <input type="text" id="role" name="role" placeholder="e.g. Senior Python Developer" required>
            </div>
            
            <div class="suggestion-box hidden" id="suggestions-1" style="margin-bottom: 20px;">
                <div class="card info">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0;">AI Suggestions</h4>
                        <button type="button" class="btn-secondary" style="width: auto; padding: 5px 10px; font-size: 0.8rem;" onclick="getSuggestions(1)">ðŸ”„ Regenerate</button>
                    </div>
                    <div id="suggestion-content-1"></div>
                </div>
            </div>
            <div class="button-group">
                <button type="button" class="btn-secondary" id="suggest-btn-1" onclick="getSuggestions(1)">âœ¨ Get AI Suggestions</button>
                <button type="button" class="btn-primary" onclick="nextStep(2)">Continue to Experience</button>
            </div>
        </div>

        <!-- Step 2: Experience -->
        <div class="form-step hidden" id="step-2">
            <h3>Step 2: Experience</h3>
            <div class="form-group">
                <label for="experience">Work Experience</label>
                <textarea id="experience" name="experience" rows="12" placeholder="For each role include:&#10;- Job Title&#10;- Company Name&#10;- Employment Type&#10;- Dates (Start - End)&#10;- Key Duties (Bullet points)&#10;&#10;Paste your work history here..." required></textarea>
            </div>
            <div class="suggestion-box hidden" id="suggestions-2" style="margin-bottom: 20px;">
                <div class="card info">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0;">AI Suggestions</h4>
                        <button type="button" class="btn-secondary" style="width: auto; padding: 5px 10px; font-size: 0.8rem;" onclick="getSuggestions(2)">ðŸ”„ Regenerate</button>
                    </div>
                    <div id="suggestion-content-2"></div>
                </div>
            </div>
            <div class="button-group">
                <button type="button" class="btn-secondary" onclick="prevStep(1)">Back</button>
                <button type="button" class="btn-secondary" id="suggest-btn-2" onclick="getSuggestions(2)">âœ¨ Get AI Suggestions</button>
                <button type="button" class="btn-primary" onclick="nextStep(3)">Continue to Education</button>
            </div>
        </div>

        <!-- Step 3: Education -->
        <div class="form-step hidden" id="step-3">
            <h3>Step 3: Education</h3>
            <div class="form-group">
                <label for="education">Education</label>
                <textarea id="education" name="education" rows="6" placeholder="University, Degree, Year..."></textarea>
            </div>
            <div class="suggestion-box hidden" id="suggestions-3" style="margin-bottom: 20px;">
                <div class="card info">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0;">AI Suggestions</h4>
                        <button type="button" class="btn-secondary" style="width: auto; padding: 5px 10px; font-size: 0.8rem;" onclick="getSuggestions(3)">ðŸ”„ Regenerate</button>
                    </div>
                    <div id="suggestion-content-3"></div>
                </div>
            </div>
            <div class="button-group">
                <button type="button" class="btn-secondary" onclick="prevStep(2)">Back</button>
                <button type="button" class="btn-secondary" id="suggest-btn-3" onclick="getSuggestions(3)">âœ¨ Get AI Suggestions</button>
                <button type="button" class="btn-primary" onclick="nextStep(4)">Continue to Skills</button>
            </div>
        </div>

        <!-- Step 4: Skills & Finalize -->
        <div class="form-step hidden" id="step-4">
            <h3>Step 4: Skills & Abilities</h3>
            <div class="form-group">
                <label for="skills">Skills (Comma separated)</label>
                <textarea id="skills" name="skills" rows="3" placeholder="Python, Flask, SQL, AWS..." required></textarea>
            </div>
            <div class="form-group">
                <label for="abilities">Abilities & Strengths</label>
                <textarea id="abilities" name="abilities" rows="3" placeholder="Leadership, Problem Solving, Team Management..."></textarea>
            </div>
            <div class="form-group">
                <label for="career_objective">Career Objective (Optional)</label>
                <input type="text" id="career_objective" name="career_objective" placeholder="Briefly state your career goal...">
            </div>
            <div class="form-group">
                <label for="links">Professional Links</label>
                <textarea id="links" name="links" rows="2" placeholder="LinkedIn, GitHub, Portfolio..."></textarea>
            </div>
            <div class="suggestion-box hidden" id="suggestions-4" style="margin-bottom: 20px;">
                <div class="card info">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0;">AI Suggestions</h4>
                        <button type="button" class="btn-secondary" style="width: auto; padding: 5px 10px; font-size: 0.8rem;" onclick="getSuggestions(4)">ðŸ”„ Regenerate</button>
                    </div>
                    <div id="suggestion-content-4"></div>
                </div>
            </div>
            <div class="button-group">
                <button type="button" class="btn-secondary" onclick="prevStep(3)">Back</button>
                <button type="button" class="btn-secondary" id="suggest-btn-4" onclick="getSuggestions(4)">âœ¨ Get AI Suggestions</button>
                <button type="button" class="btn-primary" onclick="showPreview()">Preview Resume</button>
            </div>
        </div>
    </form>
</div>

<!-- Preview Section (Hidden by default) -->
<div class="form-container hidden" id="preview-section">
    <h2>Resume Preview</h2>
    <p class="subtitle">Review your details before submitting for AI analysis.</p>

    <div class="preview-box">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <h3 id="prev-name"></h3>
                <p><strong>Role:</strong> <span id="prev-role"></span> (<span id="prev-job-level"></span> - <span id="prev-job-type"></span>)</p>
                <p><strong>Contact:</strong> <span id="prev-phone"></span> | <span id="prev-email"></span></p>
                <p><strong>Location:</strong> <span id="prev-country"></span> (Target: <span id="prev-location-target"></span>)</p>
            </div>
            <img id="prev-photo-img" src="" alt="Profile Photo" style="width: 100px; height: 100px; object-fit: cover; border-radius: 5px; display: none;">
        </div>
        <hr style="border: 0; border-top: 1px solid #e2e8f0; margin: 1rem 0;">
        
        <h4>Skills</h4>
        <p id="prev-skills"></p>

        <h4>Abilities</h4>
        <p id="prev-abilities"></p>
        
        <h4>Experience</h4>
        <p id="prev-experience" class="preserve-lines"></p>
        
        <h4>Education</h4>
        <p id="prev-education" class="preserve-lines"></p>

        <h4>Professional Links</h4>
        <p id="prev-links"></p>
    </div>

    <div class="button-group">
        <button type="button" class="btn-secondary" onclick="editResume()">Edit</button>
        <button type="button" class="btn-primary" id="submit-btn" onclick="submitResume()">Confirm & Analyze</button>
    </div>
</div>

<script>
    function nextStep(step) {
        // Simple validation for Step 1
        if (step === 2) {
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            if (!name || !phone) { alert('Please fill in required fields'); return; }
        }
        
        document.querySelectorAll('.form-step').forEach(el => el.classList.add('hidden'));
        document.getElementById('step-' + step).classList.remove('hidden');
        
        // Update indicators
        document.querySelectorAll('.step-indicator').forEach(el => {
            el.style.background = '#e5e7eb'; el.style.color = '#666';
        });
        document.getElementById('ind-' + step).style.background = '#4f46e5';
        document.getElementById('ind-' + step).style.color = 'white';
        
        window.scrollTo(0,0);
    }

    function prevStep(step) {
        nextStep(step);
    }

    async function getSuggestions(step) {
        const btn = document.getElementById(`suggest-btn-${step}`);
        const container = document.getElementById(`suggestions-${step}`);
        const content = document.getElementById(`suggestion-content-${step}`);
        
        // Collect data
        const formData = {};
        const inputs = document.getElementById(`step-${step}`).querySelectorAll('input, select, textarea');
        inputs.forEach(input => formData[input.name] = input.value);
        
        // Add job_type and role from step 1 if we are in later steps, as context is needed
        if (step > 1) {
            formData['job_type'] = document.getElementById('job_type').value;
            formData['role'] = document.getElementById('role').value;
            formData['job_level'] = document.getElementById('job_level').value;
        }

        btn.disabled = true;
        btn.innerHTML = 'Thinking... <span class="spinner"></span>';
        
        try {
            const response = await fetch('/api/suggest', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({step, formData})
            });
            const data = await response.json();
            
            let html = '';

            // Handle Wizard Response (Step 1 & 3)
            if (data.review) {
                html += `<p><strong>Review:</strong> ${data.review}</p>`;
                if (data.suggestions && data.suggestions.length > 0) {
                    html += `<ul>${data.suggestions.map(s => `<li>${s}</li>`).join('')}</ul>`;
                }
                if (data.keywords && data.keywords.length > 0) {
                    html += `<p><strong>Recommended Keywords:</strong> <div class="tags">${data.keywords.map(k => `<span class="tag">${k}</span>`).join('')}</div></p>`;
                }
            }
            
            // Handle Enhancer Response (Step 2 - Experience)
            else if (data.experience && step === 2) {
                const expData = data.experience.length > 0 ? data.experience[0] : {};
                if (expData.enhanced_bullets && expData.enhanced_bullets.length > 0) {
                    html += `<p><strong>Click to Add Enhanced Bullets:</strong></p>`;
                    html += `<div style="display: flex; flex-direction: column; gap: 10px;">`;
                    expData.enhanced_bullets.forEach(bullet => {
                        html += `<button type="button" class="btn-secondary" style="text-align: left; font-size: 0.9rem; padding: 8px;" onclick="addText('experience', '${bullet.replace(/'/g, "\\'")}')">âž• ${bullet}</button>`;
                    });
                    html += `</div>`;
                }
                if (expData.suggested_keywords && expData.suggested_keywords.length > 0) {
                    html += `<p style="margin-top: 15px;"><strong>Keywords:</strong> <div class="tags">${expData.suggested_keywords.map(k => `<span class="tag">${k}</span>`).join('')}</div></p>`;
                }
            }
            
            // Handle Enhancer Response (Step 4 - Skills)
            else if (data.skills && step === 4) {
                if (data.skills.suggested_additional && data.skills.suggested_additional.length > 0) {
                    html += `<p><strong>Click to Add Skills:</strong></p>`;
                    html += `<div class="tags">`;
                    data.skills.suggested_additional.forEach(skill => {
                        html += `<span class="tag" style="cursor: pointer; border: 1px solid var(--primary);" onclick="addText('skills', '${skill.replace(/'/g, "\\'")}', true)">âž• ${skill}</span>`;
                    });
                    html += `</div>`;
                }

                if (data.summary) {
                    if (data.summary.suggested_abilities && data.summary.suggested_abilities.length > 0) {
                        html += `<p style="margin-top: 15px;"><strong>Click to Add Abilities:</strong></p>`;
                        html += `<div class="tags">`;
                        data.summary.suggested_abilities.forEach(ability => {
                            html += `<span class="tag" style="cursor: pointer; border: 1px solid var(--primary); background: #fff7ed; color: #c2410c;" onclick="addText('abilities', '${ability.replace(/'/g, "\\'")}', true)">âž• ${ability}</span>`;
                        });
                        html += `</div>`;
                    }
                    if (data.summary.suggested_objective) {
                        html += `<p style="margin-top: 15px;"><strong>Suggested Objective:</strong></p>`;
                        html += `<div style="background: #f9fafb; padding: 10px; border-radius: 6px; border: 1px solid #e5e7eb; font-size: 0.9rem;">${data.summary.suggested_objective}</div>`;
                        html += `<button type="button" class="btn-secondary" style="margin-top: 5px; font-size: 0.8rem; padding: 5px 10px;" onclick="fillField('career_objective', '${data.summary.suggested_objective.replace(/'/g, "\\'")}')">Use this Objective</button>`;
                    }
                }
                
                if (data.optional_sections && data.optional_sections.suggested_links && data.optional_sections.suggested_links.length > 0) {
                     html += `<p style="margin-top: 15px;"><strong>Suggested Links:</strong></p>`;
                     html += `<div class="tags">`;
                     data.optional_sections.suggested_links.forEach(link => {
                        html += `<span class="tag" style="cursor: pointer; border: 1px solid var(--primary); background: #f0fdf4; color: #166534;" onclick="addText('links', '${link.replace(/'/g, "\\'")}', true)">âž• ${link}</span>`;
                     });
                     html += `</div>`;
                }
            }

            if (!html) {
                html = '<p style="color: #666; font-style: italic;">No specific suggestions available yet. Try adding more details.</p>';
            }
            
            content.innerHTML = html;
            container.classList.remove('hidden');
        } catch (e) {
            alert('Error getting suggestions');
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'âœ¨ Get AI Suggestions';
        }
    }

    function addText(fieldId, text, isCommaSeparated = false) {
        const field = document.getElementById(fieldId);
        if (isCommaSeparated) {
            if (field.value.trim().length > 0) {
                field.value += ', ' + text;
            } else {
                field.value = text;
            }
        } else {
            field.value += '\nâ€¢ ' + text;
        }
    }

    function fillField(fieldId, text) {
        const field = document.getElementById(fieldId);
        field.value = text;
    }

    function showPreview() {
        const name = document.getElementById('name').value;
        const phone = document.getElementById('phone').value;
        const email = document.getElementById('email').value;
        const country = document.getElementById('country').value;
        const jobType = document.getElementById('job_type').value;
        const jobLevel = document.getElementById('job_level').value;
        const yearsExp = document.getElementById('years_experience').value;
        const locTarget = document.getElementById('location_target').value;
        const funcFocus = document.getElementById('functional_focus').value;
        const role = document.getElementById('role').value;
        const skills = document.getElementById('skills').value;
        const abilities = document.getElementById('abilities').value;
        const experience = document.getElementById('experience').value;
        const education = document.getElementById('education').value;
        const links = document.getElementById('links').value;
        const photoInput = document.getElementById('photo');

        if(!name || !role || !skills || !experience || !phone || !email || !country || !jobType || !jobLevel || !yearsExp || !locTarget || !funcFocus) {
            alert("Please fill in all required fields.");
            return;
        }

        // Validate Links
        if (links) {
            const items = links.split(',');
            const urlRegex = /(https?:\/\/)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)/;
            for (let item of items) {
                item = item.trim();
                if (item && !urlRegex.test(item)) {
                    alert(`Invalid URL detected: "${item}". Please enter a valid URL (e.g., linkedin.com/in/name).`);
                    return;
                }
            }
        }

        document.getElementById('prev-name').textContent = name;
        document.getElementById('prev-phone').textContent = phone;
        document.getElementById('prev-email').textContent = email;
        document.getElementById('prev-country').textContent = country;
        document.getElementById('prev-job-type').textContent = jobType;
        document.getElementById('prev-job-level').textContent = jobLevel;
        document.getElementById('prev-location-target').textContent = locTarget;
        document.getElementById('prev-role').textContent = role;
        document.getElementById('prev-skills').textContent = skills;
        document.getElementById('prev-abilities').textContent = abilities;
        document.getElementById('prev-experience').textContent = experience;
        document.getElementById('prev-education').textContent = education;
        document.getElementById('prev-links').textContent = links;

        // Handle Photo Preview
        const photoImg = document.getElementById('prev-photo-img');
        if (photoInput.files && photoInput.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                photoImg.src = e.target.result;
                photoImg.style.display = 'block';
            }
            reader.readAsDataURL(photoInput.files[0]);
        } else {
            photoImg.style.display = 'none';
            photoImg.src = "";
        }

        document.getElementById('input-section').classList.add('hidden');
        document.getElementById('preview-section').classList.remove('hidden');
        window.scrollTo(0,0);
    }

    function editResume() {
        document.getElementById('preview-section').classList.add('hidden');
        document.getElementById('input-section').classList.remove('hidden');
        nextStep(4); // Go back to last step
        window.scrollTo(0,0);
    }

    function submitResume() {
        const btn = document.getElementById('submit-btn');
        btn.disabled = true;
        btn.innerHTML = 'AI is reviewing... <span class="spinner"></span>';
        document.getElementById('resumeForm').submit();
    }
</script>
{% endblock %}